# Client Lifecycle

An Undici [Client](Client.md) can be best described as a state machine. A `Client` begins in the **idle** state with no socket connection and no requests in queue. At any point the `Client` can transition to a **closing** or **destroyed** state (more on these later). From the **idle** state, the `Client` can transition to the **processing** state. Upon entering the **processing** state, the `Client` will connect the internal socket to the origin url and then begin processing any requests in the queue. During the **processing** state, more requests may be queued for processing. Once the queue is empty and the keepAliveTimeout runs out, the internal socket will disconnect and the `Client` will transition back to the **idle** state. If more requests are queued, the `Client` will once again transition to the **processing** state. As stated previously, at any time the `Client` can be transitioned to the **closisng** or **destroyed** state. When the `Client` transitions to the **closing** state, it will gracefully process any existing requests in the queue before transitioning to the **destroyed** state. When the `Client` transitions to the **destroyed** state it immediately disconnects from an existing socket connection and sends an error to all existing requests.

[![A state diagram representing an Undici Client instance](https://mermaid.ink/img/eyJjb2RlIjoic3RhdGVEaWFncmFtLXYyXG4gICAgWypdIC0tPiBpZGxlXG4gICAgcHJvY2Vzc2luZyAtLT4gY2xvc2luZyA6IGNsb3NlXG4gICAgaWRsZSAtLT4gY2xvc2luZyA6IGNsb3NlXG4gICAgaWRsZSAtLT4gZGVzdHJveWVkIDogZGVzdHJveVxuICAgIGlkbGUgLS0-IHByb2Nlc3NpbmcgOiBjb25uZWN0XG4gICAgcHJvY2Vzc2luZyAtLT4gaWRsZSA6IGRpc2Nvbm5lY3RcbiAgICBwcm9jZXNzaW5nIC0tPiBkZXN0cm95ZWQgOiBkZXN0cm95XG4gICAgY2xvc2luZyAtLT4gZGVzdHJveWVkIDogZGVzdHJveVxuICAgIGRlc3Ryb3llZCAtLT4gWypdIiwibWVybWFpZCI6eyJ0aGVtZSI6ImJhc2UifSwidXBkYXRlRWRpdG9yIjpmYWxzZX0)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoic3RhdGVEaWFncmFtLXYyXG4gICAgWypdIC0tPiBpZGxlXG4gICAgcHJvY2Vzc2luZyAtLT4gY2xvc2luZyA6IGNsb3NlXG4gICAgaWRsZSAtLT4gY2xvc2luZyA6IGNsb3NlXG4gICAgaWRsZSAtLT4gZGVzdHJveWVkIDogZGVzdHJveVxuICAgIGlkbGUgLS0-IHByb2Nlc3NpbmcgOiBjb25uZWN0XG4gICAgcHJvY2Vzc2luZyAtLT4gaWRsZSA6IGRpc2Nvbm5lY3RcbiAgICBwcm9jZXNzaW5nIC0tPiBkZXN0cm95ZWQgOiBkZXN0cm95XG4gICAgY2xvc2luZyAtLT4gZGVzdHJveWVkIDogZGVzdHJveVxuICAgIGRlc3Ryb3llZCAtLT4gWypdIiwibWVybWFpZCI6eyJ0aGVtZSI6ImJhc2UifSwidXBkYXRlRWRpdG9yIjpmYWxzZX0)

## Processing state

A `Client` transitions to the **processing** state during the [`Client.dispatch()`](#clientdispatchoptions-handlers) method. The [`Client.connect()`](#clientconnectoptions--callback), [`Client.pipeline()`](#clientpipelineoptions-handler), [`Client.request()`](#clientrequestoptions--callback), [`Client.stream()`](#clientstreamoptions-factory--callback), and [`Client.upgrade()`](#clientupgradeoptions-callback) methods are all based on [`Client.dispatch()`](#clientdispatchoptions-handlers); thus, they all cause a **processing** state transition when called.

Upon entering this state, the `Client` establishes a socket connection and emits the [`'connect'`](Client.md#event-connect) event signalling a connection was successfully established with the `origin` provided during `Client` instantiation.

While in this state, the `Client` is actively processing requests stored in the internal queue. If pipelining is enabled, the `Client` is processing the requests in parallel. Once all of the requests have been processed, the `Client` will remain in this state until the end of the `keepAliveTimeout`. Once the socket connection timesout, the `Client` emits a [`'disconnect'`](#event-disconnect) event and returns to the `idle` state.
